<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã”æ³¨æ–‡æ‰‹ç¶šã - HealSweets</title>
    <link rel="stylesheet" th:href="@{/css/checkout-style.css}">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header th:replace="~{fragments/header :: headerSimple}"></header>

    <!-- ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="checkout-section">
        <div class="container">
            <h1>ã”æ³¨æ–‡æ‰‹ç¶šã</h1>

            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div th:if="${errorMessage}" class="alert alert-error">
                <p th:text="${errorMessage}">ã‚¨ãƒ©ãƒ¼</p>
            </div>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="step-indicator">
                <div class="step" th:classappend="${currentStep >= 1} ? 'active' : ''">
                    <div class="step-number">1</div>
                    <div class="step-label">ãŠå±Šã‘å…ˆ</div>
                </div>
                <div class="step-line"></div>
                <div class="step" th:classappend="${currentStep >= 2} ? 'active' : ''">
                    <div class="step-number">2</div>
                    <div class="step-label">ãŠæ”¯æ‰•ã„æ–¹æ³•</div>
                </div>
                <div class="step-line"></div>
                <div class="step" th:classappend="${currentStep >= 3} ? 'active' : ''">
                    <div class="step-number">3</div>
                    <div class="step-label">æ³¨æ–‡ç¢ºèª</div>
                </div>
            </div>

            <div class="checkout-content">
                <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="checkout-main">
                    <form th:action="@{${currentStep < 3 ? '/checkout/confirm' : '/checkout/complete'}}" 
                          th:object="${checkoutDto}" method="post">
                        
                        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãŠå±Šã‘å…ˆæƒ…å ± -->
                        <div th:if="${currentStep == 1}" class="checkout-step active" id="step1">
                            <h2>ãŠå±Šã‘å…ˆæƒ…å ±</h2>

                            <div class="saved-address">
                                <div class="address-card selected">
                                    <div class="address-header">
                                        <span class="address-name" th:text="${member.fullName}">ç”°ä¸­ å¤ªéƒ</span>
                                        <span class="default-badge">æ—¢å®š</span>
                                    </div>
                                    <p class="address-detail" th:text="'ã€’' + ${member.postalCode}">ã€’123-4567</p>
                                    <p class="address-detail" th:text="${member.prefecture + member.city + member.address1}">æ±äº¬éƒ½æ¸‹è°·åŒºâ—‹â—‹ 1-2-3</p>
                                    <p th:if="${member.address2}" class="address-detail" th:text="${member.address2}"></p>
                                    <p class="address-detail" th:text="'é›»è©±: ' + ${member.phone}">é›»è©±: 090-1234-5678</p>
                                </div>
                            </div>

                            <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                            <input type="hidden" th:field="*{shippingName}" th:value="${member.fullName}">
                            <input type="hidden" th:field="*{shippingPostalCode}" th:value="${member.postalCode}">
                            <input type="hidden" th:field="*{shippingPrefecture}" th:value="${member.prefecture}">
                            <input type="hidden" th:field="*{shippingCity}" th:value="${member.city}">
                            <input type="hidden" th:field="*{shippingAddress1}" th:value="${member.address1}">
                            <input type="hidden" th:field="*{shippingAddress2}" th:value="${member.address2}">
                            <input type="hidden" th:field="*{shippingPhone}" th:value="${member.phone}">

                            <div class="delivery-options">
                                <h3>é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
                                <div class="delivery-card selected">
                                    <label>
                                        <input type="radio" th:field="*{deliveryOption}" value="standard" checked>
                                        <div class="delivery-info">
                                            <span class="delivery-name">é€šå¸¸é…é€</span>
                                            <span class="delivery-price">Â¥500</span>
                                        </div>
                                        <p class="delivery-time">ãŠå±Šã‘äºˆå®š: 2-3å–¶æ¥­æ—¥</p>
                                    </label>
                                </div>
                                <div class="delivery-card">
                                    <label>
                                        <input type="radio" th:field="*{deliveryOption}" value="express">
                                        <div class="delivery-info">
                                            <span class="delivery-name">ãŠæ€¥ãä¾¿</span>
                                            <span class="delivery-price">Â¥1,000</span>
                                        </div>
                                        <p class="delivery-time">ãŠå±Šã‘äºˆå®š: ç¿Œæ—¥é…é€</p>
                                    </label>
                                </div>
                            </div>

                            <h3>ãŠæ”¯æ‰•ã„æ–¹æ³•</h3>
                            <div class="payment-methods">
                                <div class="payment-card selected">
                                    <label>
                                        <input type="radio" th:field="*{paymentMethod}" value="credit" checked>
                                        <span class="payment-icon">ğŸ’³</span>
                                        <span class="payment-name">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
                                    </label>
                                </div>
                                <div class="payment-card">
                                    <label>
                                        <input type="radio" th:field="*{paymentMethod}" value="bank">
                                        <span class="payment-icon">ğŸ¦</span>
                                        <span class="payment-name">éŠ€è¡ŒæŒ¯è¾¼</span>
                                    </label>
                                </div>
                                <div class="payment-card">
                                    <label>
                                        <input type="radio" th:field="*{paymentMethod}" value="cod">
                                        <span class="payment-icon">ğŸ’µ</span>
                                        <span class="payment-name">ä»£é‡‘å¼•æ›</span>
                                    </label>
                                </div>
                                <div class="payment-card">
                                    <label>
                                        <input type="radio" th:field="*{paymentMethod}" value="conbini">
                                        <span class="payment-icon">ğŸª</span>
                                        <span class="payment-name">ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆ</span>
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="next-btn">æ³¨æ–‡ç¢ºèªã¸é€²ã‚€</button>
                        </div>

                        <!-- ã‚¹ãƒ†ãƒƒãƒ—3: æ³¨æ–‡ç¢ºèª -->
                        <div th:if="${currentStep == 3}" class="checkout-step active" id="step3">
                            <h2>ã”æ³¨æ–‡å†…å®¹ã®ç¢ºèª</h2>

                            <div class="confirmation-section">
                                <div class="confirmation-box">
                                    <h4>ãŠå±Šã‘å…ˆ</h4>
                                    <p th:text="${checkoutDto.shippingName}">ç”°ä¸­ å¤ªéƒ</p>
                                    <p th:text="'ã€’' + ${checkoutDto.shippingPostalCode}">ã€’123-4567</p>
                                    <p th:text="${checkoutDto.shippingPrefecture + checkoutDto.shippingCity + checkoutDto.shippingAddress1}">ä½æ‰€</p>
                                    <p th:if="${checkoutDto.shippingAddress2}" th:text="${checkoutDto.shippingAddress2}"></p>
                                    <p th:text="'é›»è©±: ' + ${checkoutDto.shippingPhone}">é›»è©±</p>
                                </div>

                                <div class="confirmation-box">
                                    <h4>é…é€æ–¹æ³•</h4>
                                    <p th:text="${checkoutDto.deliveryOption == 'express' ? 'ãŠæ€¥ãä¾¿ï¼ˆç¿Œæ—¥é…é€ï¼‰' : 'é€šå¸¸é…é€ï¼ˆ2-3å–¶æ¥­æ—¥ï¼‰'}">é€šå¸¸é…é€</p>
                                </div>

                                <div class="confirmation-box">
                                    <h4>ãŠæ”¯æ‰•ã„æ–¹æ³•</h4>
                                    <p th:text="${checkoutDto.paymentMethod == 'credit' ? 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' : 
                                                 (checkoutDto.paymentMethod == 'bank' ? 'éŠ€è¡ŒæŒ¯è¾¼' : 
                                                 (checkoutDto.paymentMethod == 'cod' ? 'ä»£é‡‘å¼•æ›' : 'ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆ'))}">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</p>
                                </div>

                                <div class="confirmation-box">
                                    <h4>ã”æ³¨æ–‡å•†å“</h4>
                                    <div class="confirm-items">
                                        <div th:each="item : ${cartItems}" class="confirm-item">
                                            <img th:src="${item.product.imageUrl}" th:alt="${item.product.name}">
                                            <div class="item-info">
                                                <p class="item-name" th:text="${item.product.name}">å•†å“å</p>
                                                <p class="item-quantity" th:text="'æ•°é‡: ' + ${item.quantity}">æ•°é‡: 1</p>
                                            </div>
                                            <p class="item-price" th:text="${item.formattedSubtotal}">Â¥0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                            <input type="hidden" th:field="*{shippingName}">
                            <input type="hidden" th:field="*{shippingPostalCode}">
                            <input type="hidden" th:field="*{shippingPrefecture}">
                            <input type="hidden" th:field="*{shippingCity}">
                            <input type="hidden" th:field="*{shippingAddress1}">
                            <input type="hidden" th:field="*{shippingAddress2}">
                            <input type="hidden" th:field="*{shippingPhone}">
                            <input type="hidden" th:field="*{deliveryOption}">
                            <input type="hidden" th:field="*{paymentMethod}">

                            <div class="terms-agreement">
                                <label class="checkbox-item">
                                    <input type="checkbox" th:field="*{agreeTerms}" required>
                                    <span>ä¸Šè¨˜ã®æ³¨æ–‡å†…å®¹ã§é–“é•ã„ã‚ã‚Šã¾ã›ã‚“ã€‚<a href="#" target="_blank">åˆ©ç”¨è¦ç´„</a>ã¨<a href="#" target="_blank">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ã¾ã™ã€‚</span>
                                </label>
                            </div>

                            <div class="button-group">
                                <a th:href="@{/checkout}" class="back-btn">æˆ»ã‚‹</a>
                                <button type="submit" class="order-btn">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- æ³¨æ–‡ã‚µãƒãƒªãƒ¼ -->
                <aside class="order-summary">
                    <h2>ã”æ³¨æ–‡å†…å®¹</h2>

                    <div class="summary-items">
                        <div class="summary-item">
                            <span>å•†å“å°è¨ˆ</span>
                            <span th:text="'Â¥' + ${#numbers.formatInteger(subtotal, 0, 'COMMA')}">Â¥0</span>
                        </div>
                        <div class="summary-item">
                            <span>é€æ–™</span>
                            <span id="shippingCost" th:text="'Â¥' + ${#numbers.formatInteger(shipping, 0, 'COMMA')}">Â¥500</span>
                        </div>
                    </div>

                    <div class="summary-divider"></div>

                    <div class="summary-total">
                        <span>åˆè¨ˆ</span>
                        <span class="total-price" id="totalPrice" th:text="'Â¥' + ${#numbers.formatInteger(total, 0, 'COMMA')}">Â¥0</span>
                    </div>

                    <div class="security-note">
                        <p>ğŸ”’ ã“ã®ã‚µã‚¤ãƒˆã¯å®‰å…¨ã«ä¿è­·ã•ã‚Œã¦ã„ã¾ã™</p>
                    </div>
                </aside>
            </div>
        </div>
    </section>

    <style>
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .alert-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .delivery-card label,
        .payment-card label {
            display: block;
            cursor: pointer;
        }
        .delivery-card input[type="radio"],
        .payment-card input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // é…é€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ç®¡ç†
            const deliveryCards = document.querySelectorAll('.delivery-card');
            deliveryCards.forEach(card => {
                const radio = card.querySelector('input[type="radio"]');
                if (radio) {
                    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
                    if (radio.checked) {
                        card.classList.add('selected');
                    }
                    
                    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
                    card.addEventListener('click', function() {
                        deliveryCards.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        radio.checked = true;
                        
                        // é€æ–™ã¨åˆè¨ˆã‚’æ›´æ–°
                        updateTotals();
                    });
                }
            });

            // æ”¯æ‰•ã„æ–¹æ³•ã®é¸æŠçŠ¶æ…‹ã‚’ç®¡ç†
            const paymentCards = document.querySelectorAll('.payment-card');
            paymentCards.forEach(card => {
                const radio = card.querySelector('input[type="radio"]');
                if (radio) {
                    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
                    if (radio.checked) {
                        card.classList.add('selected');
                    }
                    
                    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
                    card.addEventListener('click', function() {
                        paymentCards.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        radio.checked = true;
                    });
                }
            });

            // é€æ–™ã¨åˆè¨ˆé‡‘é¡ã‚’æ›´æ–°
            function updateTotals() {
                const selectedDelivery = document.querySelector('.delivery-card.selected input[type="radio"]');
                if (selectedDelivery) {
                    const shippingCost = selectedDelivery.value === 'express' ? 1000 : 500;
                    const shippingElement = document.getElementById('shippingCost');
                    const totalElement = document.getElementById('totalPrice');
                    
                    if (shippingElement && totalElement) {
                        shippingElement.textContent = 'Â¥' + shippingCost.toLocaleString();
                        
                        // ç¾åœ¨ã®å°è¨ˆã‚’å–å¾—ã—ã¦åˆè¨ˆã‚’è¨ˆç®—
                        const subtotalText = document.querySelector('.summary-item span:last-child').textContent;
                        const subtotal = parseInt(subtotalText.replace(/[Â¥,]/g, ''));
                        const total = subtotal + shippingCost;
                        totalElement.textContent = 'Â¥' + total.toLocaleString();
                    }
                }
            }
        });
    </script>
</body>
</html>
